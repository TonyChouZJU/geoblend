
import numpy as np
import pyamg
from geoblend.b import b


def test_b_rectangular():
    
    mask = np.array([
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 1, 1, 1, 1, 1, 1, 1, 0],
        [0, 1, 1, 1, 1, 1, 1, 1, 0],
        [0, 1, 1, 1, 1, 1, 1, 1, 0],
        [0, 1, 1, 1, 1, 1, 1, 1, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0]
    ], dtype=np.uint8)

    reference = np.array([
        [555, 555, 514, 514, 514, 514, 479, 479, 479],
        [555, 555, 514, 514, 514, 514, 479, 479, 479],
        [555, 555, 514, 514, 514, 514, 479, 479, 479],
        [504, 504, 472, 472, 472, 472, 458, 458, 458],
        [504, 504, 472, 472, 472, 472, 458, 458, 458],
        [504, 504, 472, 472, 472, 472, 458, 458, 458]
    ], dtype=np.uint16)

    field = np.array([
        [869,  517,  665,  618,  790,  599,  537,  616, 1287],
        [347,   -8,  -63,   -6,  -83,  -64,  -43,  186,  676],
        [425, -107,  -18,   96, -157,  -80, -118,   -6,  425],
        [443,  346,   57,   69,  -22,  -69,  -13,  -67,  596],
        [406,  -24,   47,   40,  -56,   54,   90,   25,  589],
        [1193, 1006,  714,  513,  712,  520,  579,  460,  942]
    ], dtype=np.int32)
    
    expected = np.array([
        2496, 588, 1080, 818, 928, 606, 3502, -386, -110, 992, -1078, 176, -660, 908, 3924, -432, 210, 250, -430, 224, 368, 1038, 1174, 1144, 352, 1446, 1504, 1986
    ], dtype=np.int32)

    vector = b(mask, field, reference)

    assert np.all(expected == vector)


def test_b():

    mask = np.array([
        [0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 1, 1, 0, 0, 0, 0],
        [0, 1, 1, 1, 1, 1, 1, 0, 0],
        [0, 0, 1, 1, 1, 1, 0, 0, 0],
        [0, 0, 0, 1, 1, 1, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0]
    ], dtype=np.uint8)

    reference = np.array([
        [555, 555, 514, 514, 514, 514, 479, 479, 479],
        [555, 555, 514, 514, 514, 514, 479, 479, 479],
        [555, 555, 514, 514, 514, 514, 479, 479, 479],
        [504, 504, 472, 472, 472, 472, 458, 458, 458],
        [504, 504, 472, 472, 472, 472, 458, 458, 458],
        [504, 504, 472, 472, 472, 472, 458, 458, 458]
    ], dtype=np.uint16)

    field = np.array([
        [869,  517,  665,  618,  790,  599,  537,  616, 1287],
        [347,   -8,  -63,   -6,  -83,  -64,  -43,  186,  676],
        [425, -107,  -18,   96, -157,  -80, -118,   -6,  425],
        [443,  346,   57,   69,  -22,  -69,  -13,  -67,  596],
        [406,  -24,   47,   40,  -56,   54,   90,   25,  589],
        [1193, 1006,  714,  513,  712,  520,  579,  460,  942]
    ], dtype=np.int32)

    expected = np.array([
        1682, 1080, 1718, 2408, -110, 992, -1078, 1076, 2048, 2306, 210, 250, 460, 2182, 352, 2542
    ], dtype=np.int32)

    vector = b(mask, field, reference)

    assert np.all(expected == vector)
